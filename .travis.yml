sudo: required
install: true  # skips unnecessary "gradle assemble" install step

services:
- docker

language: java

addons:
  sonarcloud:
    organization: "fredboat"

env:
  global:
    - BUILD_NUMBER: "$TRAVIS_BUILD_NUMBER"

# See https://github.com/travis-ci/docs-travis-ci-com/pull/611#issuecomment-321394366
before_cache:
  - rm -fr $HOME/.gradle/caches/build-cache-1/
  - rm -fr $HOME/.gradle/caches/journal-1/
  - rm -f  $HOME/.gradle/caches/modules-2/metadata-*/module-metadata.bin
  - rm -f  $HOME/.gradle/caches/modules-2/metadata-*/resource-at-url.bin
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/*/executionHistory/executionHistory.lock
  - rm -f  $HOME/.gradle/caches/*/fileContent/fileContent.lock
  - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.bin
  - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.lock
  - rm -f  $HOME/.gradle/caches/*/javaCompile/javaCompile.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - "$HOME/.m2"
    - "$HOME/.gradle/wrapper"
    - "$HOME/.gradle/caches"
    - "$HOME/.sonar/cache"

stages:
  - assemble
  - test

jobs:
  fast_finish: true
  allow_failures:
    - jdk: openjdk-ea
    - jdk: oraclejdk-ea
  include:
    - stage: assemble
      jdk: openjdk10
      before_script:
        - "java -Xmx32m -version"
      script:
        - "./gradlew assemble --info"

    - stage: assemble
      jdk: openjdk-ea
      before_script:
        - "java -Xmx32m -version"
      script:
        - "./gradlew assemble --info"

    - stage: assemble
      jdk: oraclejdk-ea
      before_script:
        - "java -Xmx32m -version"
      script:
        - "./gradlew assemble --info"

    - stage: test
      jdk: openjdk10
      before_script:
        - "java -Xmx32m -version"
        #for full sonar cloud blame information
        - "git fetch --unshallow"
      script:
        - "./gradlew sonarqube"
